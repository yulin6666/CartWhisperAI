<!DOCTYPE html>
<html>
<head>
  <title>CartWhisper - 推荐数量诊断工具</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .section {
      background: #f5f5f5;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
    }
    button {
      background: #000;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #333;
    }
    .result {
      background: #fff;
      padding: 15px;
      margin: 10px 0;
      border-left: 4px solid #4CAF50;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .error {
      border-left-color: #f44336;
    }
  </style>
</head>
<body>
  <h1>CartWhisper 推荐数量诊断工具</h1>

  <div class="section">
    <h2>1. 检查localStorage缓存</h2>
    <button onclick="checkLocalStorage()">查看缓存</button>
    <button onclick="clearLocalStorage()">清除缓存</button>
    <div id="localStorage-result"></div>
  </div>

  <div class="section">
    <h2>2. 检查当前推荐设置</h2>
    <button onclick="checkCurrentSettings()">检查设置</button>
    <div id="settings-result"></div>
  </div>

  <div class="section">
    <h2>3. 测试API请求</h2>
    <p>商店域名: <input type="text" id="shop" placeholder="example.myshopify.com" style="width: 300px;"></p>
    <p>商品ID: <input type="text" id="productId" placeholder="12345678" style="width: 300px;"></p>
    <p>请求数量: <input type="number" id="limit" value="2" min="1" max="6" style="width: 100px;"></p>
    <button onclick="testAPI()">测试API</button>
    <div id="api-result"></div>
  </div>

  <script>
    function checkLocalStorage() {
      const result = document.getElementById('localStorage-result');
      const keys = [];

      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('cartwhisper_rec_')) {
          const data = JSON.parse(localStorage.getItem(key));
          const age = Math.round((Date.now() - data.timestamp) / 1000 / 60); // 分钟
          keys.push({
            key: key,
            age: age,
            count: data.recommendations?.length || 0,
            limit: data.limit
          });
        }
      }

      if (keys.length === 0) {
        result.innerHTML = '<div class="result">没有找到缓存</div>';
      } else {
        const html = keys.map(item =>
          `Key: ${item.key}\nLimit: ${item.limit}\n推荐数量: ${item.count}\n缓存时间: ${item.age}分钟前`
        ).join('\n\n');
        result.innerHTML = `<div class="result">找到 ${keys.length} 个缓存:\n\n${html}</div>`;
      }
    }

    function clearLocalStorage() {
      let count = 0;
      const keys = [];

      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('cartwhisper_rec_')) {
          keys.push(key);
        }
      }

      keys.forEach(key => {
        localStorage.removeItem(key);
        count++;
      });

      const result = document.getElementById('localStorage-result');
      result.innerHTML = `<div class="result">已清除 ${count} 个缓存</div>`;

      setTimeout(() => {
        checkLocalStorage();
      }, 500);
    }

    function checkCurrentSettings() {
      const result = document.getElementById('settings-result');
      const popup = document.getElementById('cart-whisper-popup');

      if (!popup) {
        result.innerHTML = '<div class="result error">未找到 cart-whisper-popup 元素\n请在商店页面运行此工具</div>';
        return;
      }

      const shop = popup.dataset.shop;
      const limit = popup.dataset.limit;

      result.innerHTML = `<div class="result">商店: ${shop}\n当前limit设置: ${limit}</div>`;
    }

    async function testAPI() {
      const shop = document.getElementById('shop').value;
      const productId = document.getElementById('productId').value;
      const limit = document.getElementById('limit').value;
      const result = document.getElementById('api-result');

      if (!shop || !productId) {
        result.innerHTML = '<div class="result error">请输入商店域名和商品ID</div>';
        return;
      }

      result.innerHTML = '<div class="result">请求中...</div>';

      try {
        const url = `https://cartwhisperaibackend-production.up.railway.app/api/public/recommendations/${encodeURIComponent(shop)}/${productId}?limit=${limit}`;

        const response = await fetch(url);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || `HTTP ${response.status}`);
        }

        result.innerHTML = `<div class="result">请求成功!\n\n请求URL: ${url}\n\n返回数据:\n${JSON.stringify(data, null, 2)}\n\n实际返回推荐数: ${data.recommendations?.length || 0}</div>`;
      } catch (error) {
        result.innerHTML = `<div class="result error">请求失败:\n${error.message}</div>`;
      }
    }
  </script>
</body>
</html>
